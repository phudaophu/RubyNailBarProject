@inject ContainerStorage ContainerStorage

@inject IUsersService UsersService

@inject IStoresService StoresService

@inject ContainerStorage ContainerStorage

@attribute [StreamRendering]

<table class="table table-striped table-hover">


    <thead>
        <tr>
            <th>
                <button class="btn border-0 btn-sm"> Index </button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Store"))">Store @GetSortIcon("Store")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Firstname"))">Fullname @GetSortIcon("Firstname")</button>
            </th>
            <th> 
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Username"))">Username @GetSortIcon("Username")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Group"))">Group @GetSortIcon("Group")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Role"))">Role @GetSortIcon("Role")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" @onclick="@(() => ToggleSort("Status"))">Status @GetSortIcon("Status")</button>
            </th>
            <th></th>
            <th></th>
            <th></th>
        </tr>

    </thead>
    <tbody>
        @if (listUsers != null && listUsers.Any() && PagedUsers != null)
        {
            int i = 0;
            @foreach (var user in PagedUsers)
            {
                <tr >
                    <td>
                        @(++i)
                    </td>
                    <td>
                        @if (user.UserGroups.Any())
                        {
                            var listStoreId = user.UserGroups
                                                    .Select(ug => ug.StoreId)
                                                    .OfType<int>()
                                                    .ToList();

                            foreach(var storeId in listStoreId)
                            {
                                <span class="badge text-dark border border-dark">@StoresService.GetStoreById(storeId).Name</span>
                                <br>
                            }
                        }
                        else
                        {
                            <span>N/A</span>
                        }
                    </td>

                    <td>
                        @($"{user.FirstName} {@user.LastName}")
                    </td>
                    <td>
                        @user.Username
                    </td>

                    <td>
                        @if (user.UserGroups.Any())
                        {
                            foreach (var group in user.UserGroups)
                            {
                                <span class="badge border @(group.GroupName == "Manager" ? "text-primary border-primary" : "text-black border-dark")">@group.GroupName</span>
                               <br />
                            }
                        }
                        else
                        {
                           <text>N/A</text>
                        }
                    </td>

                    <td>
                        @if (user.UserGroups.Any())
                        {
                            foreach (var group in user.UserGroups)
                            {
                                <span class="badge border @(group.RoleName == "Admin" ? "text-primary border-primary" : "text-black border-dark")">@group.RoleName</span>
                                <br />
                            }
                        }
                        else
                        {
                            <text>N/A</text>
                        }
                    </td>
                    <td>
                        <span class="badge  border @(user.IsActive ? "text-success border-success" : "text-danger border-danger")">@(user.IsActive ? "Active" : "InActive")</span>

                    </td>
                    <td>
                        @if (user.IsActive == true)
                        {
                            <button type="button" class="btn btn-outline-danger btn-sm px-2 py-0 text-nowrap"
                                    @onclick="@(() => {
                                                        SetUserStatus(user.UserId,false);
                                                                                             })">
                              Turn Off
                          </button>
                    }
                                else
                    {
                        <button type="button" class="btn btn-outline-success btn-sm px-2 py-0 text-nowrap"
                                    @onclick="@(() => { 
                                                         SetUserStatus(user.UserId,true);
                                                                                            })">
                          Turn On
                      </button>
                    }
                    &nbsp;
                    </td>
                    <td>
                <a class="btn btn-outline-primary btn-sm px-2 py-0 text-nowrap" href=@($"/user/{user.UserId}")> Edit </a>
                    </td>
                    <td>
                <a class="btn btn-outline-primary btn-sm px-2 py-0 text-nowrap" href=@($"/usergroups/{user.UserId}")> Edit Group </a>
                    </td>
                </tr>
            }

        }


        else
        {
            <tr>
                <td class="text-center text-black-50" colspan="10">
                    @statusUserListView
                </td>
            </tr>
        }

    </tbody>


</table>




@code {


    private List<User>? PagedUsers { get; set; }

    [Parameter]
    public int CurrentPage { get; set; }

    [Parameter]
    public int PageSize { get; set; }

    [Parameter]
    public EventCallback<int> TotalPagesCallBack { get; set; }

    private int previousTotalPage = -1;

    private void UpdatePagedUsers()
    {
        if (listUsers is not null && listUsers.Any())
        {
            PagedUsers = listUsers.Skip((CurrentPage - 1) * PageSize)
                                   .Take(PageSize)
                                    .ToList();
            int _totalPage = (int)Math.Ceiling((double)listUsers.Count / PageSize);

            if (previousTotalPage != _totalPage)
            {
                previousTotalPage = _totalPage; 
                TotalPagesCallBack.InvokeAsync(_totalPage);
                ContainerStorage.setTotalPages(_totalPage);
            }
            else
            {
                ContainerStorage.setTotalPages(_totalPage);

            }

        }

    }

    [Parameter]
    public string? FilteredUsersData { set; get; }

    private List<User>? listUsers = new List<User>();

    private bool isFirstRender = true;

    private string? statusUserListView = "Data Is Loading...";


    private Dictionary<string, int> sortStates = new()
    {
        { "Store",     0 },
        { "Firstname", 0 },
        { "Username",  0 },
        { "Group",     0 },
        { "Status",    0 },
        { "Role",      0 }
    };



    private void ToggleSort(string column)
    {
        if (listUsers is null || !listUsers.Any())
            return;

        // reset other columns
        foreach (var key in sortStates.Keys.ToList())
        {
            if (key != column)
            {
                sortStates[key] = 0;
            }
        }

        // advance states
        sortStates[column]++;

        if (sortStates[column] > 2)
        {
            sortStates[column] = 0;
        }

        switch (column)
        {
            case "Firstname":
                ApplyLogicSort(u => u.FirstName, column);
                break;

            case "Store":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Username":
                ApplyLogicSort(u => u.Username, column);
                break;

            case "Group":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Role":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Status":
                ApplyLogicSort(u => u.IsActive, column);
                break;
        }

        StateHasChanged();
    }


    private RenderFragment GetSortIcon(string column) => builder =>
    {
        string icon = sortStates[column] switch
        {
            1 => "▲", // ascending
            2 => "▼", // descending
            _ => ""
        };
        builder.AddContent(0, icon);
    };


    private void ApplyLogicSort<TKey>(Func<User,TKey> selector, string column)
    {
        switch (this.sortStates[column])
        {
            case 0:
                listUsers = UsersService.GetUsersService();
                UpdatePagedUsers();
                break;

            case 1:
                if(listUsers != null)
                {
                    listUsers = listUsers.OrderBy(selector).ToList();
                    UpdatePagedUsers();
                }
                break;

            case 2:
                if(listUsers != null)
                {
                    listUsers = listUsers.OrderByDescending(selector).ToList();
                    UpdatePagedUsers();
                }
                break;
        }
    }

    protected override void OnParametersSet()
    {
        if (isFirstRender == false)
        {
            if (string.IsNullOrWhiteSpace(this.FilteredUsersData))
            {
                listUsers = UsersService.GetUsersService();

            }
            else
            {
                listUsers = UsersService.SearchUserService(FilteredUsersData);
                if (listUsers is null || listUsers.Count == 0)
                {
                    statusUserListView = "No User Found";
                }

            }
            this.PageSize = ContainerStorage.getLastPageSize();
            this.CurrentPage = ContainerStorage.getLastCurrentPage();
  
            
            
            UpdatePagedUsers();
            StateHasChanged();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isFirstRender = false;
            if (string.IsNullOrWhiteSpace(this.FilteredUsersData))
            {
                listUsers = UsersService.GetUsersService();

            }
            else
            {
                listUsers = UsersService.SearchUserService(FilteredUsersData);
                if (listUsers is null || listUsers.Count ==0)
                {
                    statusUserListView = "No User Found";
                }

            }
            // if (ContainerStorage.hasPaginationDataChanged())
            // {
            //     this.CurrentPage = ContainerStorage.getLastPaginationData()["currentPage"];
            //     this.PageSize = ContainerStorage.getLastPaginationData()["pageSize"];
            //     this.previousTotalPage = ContainerStorage.getLastPaginationData()["totalPages"];
            // }
            this.CurrentPage = ContainerStorage.getLastCurrentPage();
            this.PageSize = ContainerStorage.getLastPageSize();
            UpdatePagedUsers();
            StateHasChanged();
        }
    }

    
    private void SetUserStatus(int userId, bool status)
    {
        var userToUpdate = UsersService.GetUserByIdService(userId);
        if (userToUpdate is not null && userToUpdate.IsActive != status)
        {
            userToUpdate.IsActive = status;
            UsersService.UpdateUserService(userId, userToUpdate);
            listUsers = UsersService.GetUsersService();
            UpdatePagedUsers();
            //StateHasChanged();
        }
        else
        {
            return;
        }
    }

    // private int currentPage = 1;
    // private int _pageSize = 5;

    // private int pageSize
    // {
    //     get => _pageSize;
    //     set
    //     {
    //         if (value > 0 && value != _pageSize)
    //         {
    //             _pageSize = value;
    //             currentPage = 1; // Optional: reset page
    //             UpdatePagedUsers(); // Refresh your paged list
    //         }
    //     }
    // }

    // private int totalPages
    // {
    //     get
    //     {
    //         if(listUsers is null || !listUsers.Any())
    //         {
    //             return 1;
    //         }
    //         return (int)Math.Ceiling((double)listUsers.Count / _pageSize);
    //     }
    // }

    // private void OnPageSizeChanged()
    // {
    //     currentPage = 1;
    //     UpdatePagedUsers();

    // }

    // private void PrevPage()
    // {
    //     if (currentPage > 1)
    //     {
    //         currentPage--;
    //         UpdatePagedUsers();
    //     }
    // }

    // private void NextPage()
    // {
    //     if (currentPage < totalPages)
    //     {
    //         currentPage++;
    //         UpdatePagedUsers();
    //     }
    // }

    // private void UpdatePagedUsers()
    // {
    //     if (listUsers is not null && listUsers.Any())
    //     {
    //         pagedUsers = listUsers
    //                     .Skip((currentPage - 1) * _pageSize)
    //                     .Take(_pageSize)
    //                     .ToList();
    //     }

    // }
}
