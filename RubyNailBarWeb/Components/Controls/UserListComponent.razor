@inject IUsersService UsersService

@inject IStoresService StoresService

@attribute [StreamRendering]

<table class="table table-striped">


    <thead>
        <tr>
            <th>
                <button class="btn border-0 btn-sm"> Index </button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Store"))">Store @GetSortIcon("Store")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Firstname"))">Fullname @GetSortIcon("Firstname")</button>
            </th>
            <th> 
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Username"))">Username @GetSortIcon("Username")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Group"))">Group @GetSortIcon("Group")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Role"))">Role @GetSortIcon("Role")</button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm" @onclick="@(() => ToggleSort("Status"))">Status @GetSortIcon("Status")</button>
            </th>
            <th></th>
            <th></th>
            <th></th>
        </tr>

    </thead>
    <tbody>
        @if (listUsers != null && listUsers.Any())
        {
            int i = 0;
            @foreach (var user in pagedUsers)
            {
                <tr>
                    <td>
                        @(++i)
                    </td>
                    <td>
                        @if (user.UserGroups.Any())
                        {
                            var listStoreId = user.UserGroups
                                                    .Select(ug => ug.StoreId)
                                                    .OfType<int>()
                                                    .ToList();

                            foreach(var storeId in listStoreId)
                            {
                                <span class="badge text-dark border border-dark">@StoresService.GetStoreById(storeId).Name</span>
                                <br>
                            }
                        }
                        else
                        {
                            <span>N/A</span>
                        }
                    </td>

                    <td>
                        @($"{user.FirstName} {@user.LastName}")
                    </td>
                    <td>
                        @user.Username
                    </td>

                    <td>
                        @if (user.UserGroups.Any())
                        {
                            foreach (var group in user.UserGroups)
                            {
                                <span class="badge border @(group.GroupName == "Manager" ? "text-primary border-primary" : "text-black border-dark")">@group.GroupName</span>
                               <br />
                            }
                        }
                        else
                        {
                           <text>N/A</text>
                        }
                    </td>

                    <td>
                        @if (user.UserGroups.Any())
                        {
                            foreach (var group in user.UserGroups)
                            {
                                <span class="badge border @(group.RoleName == "Admin" ? "text-primary border-primary" : "text-black border-dark")">@group.RoleName</span>
                                <br />
                            }
                        }
                        else
                        {
                            <text>N/A</text>
                        }
                    </td>
                    <td>
                        <span class="badge  border @(user.IsActive ? "text-success border-success" : "text-danger border-danger")">@(user.IsActive ? "Active" : "InActive")</span>

                    </td>
                    <td>
                        @if (user.IsActive == true)
                        {
                            <button type="button" class="btn btn-outline-danger"
                                    @onclick="@(() => {
                                                        SetUserStatus(user.UserId,false);
                                                                                             })">
                              Turn Off
                          </button>
                    }
                                else
                    {
                        <button type="button" class="btn btn-outline-success"
                                    @onclick="@(() => { 
                                                         SetUserStatus(user.UserId,true);
                                                                                            })">
                          Turn On
                      </button>
                    }
                    &nbsp;
                    </td>
                    <td>
                        <a class="btn btn-outline-primary" href=@($"/user/{user.UserId}")> Edit </a>
                    </td>
                    <td>
                        <a class="btn btn-outline-danger" href=@($"/usergroups/{user.UserId}")> Edit Group </a>
                    </td>
                </tr>
            }


        }


        else
        {
            <tr>
                <td class="text-center text-black-50" colspan="10">
                    @statusUserListView
                </td>
            </tr>
        }

    </tbody>


</table>


<div class="d-flex justify-content-end align-items-center mt-3">
    <button class="@(currentPage == 1 ? "btn btn-sm btn-light" : "btn btn-sm btn-secondary")" @onclick="PrevPage" disabled="@(currentPage == 1)">←</button>
    &nbsp;
    <span>Page @currentPage of @totalPages</span>
    &nbsp; 
    <button class="@(currentPage == totalPages ? "btn btn-sm btn-light" : "btn btn-sm btn-secondary")" @onclick="NextPage" disabled="@(currentPage == totalPages)">→</button>
</div>

@code {

    private List<User> pagedUsers = new List<User>();

    private int currentPage = 1;

    private int pageSize = 5;

    private int totalPages
    {
        get
        {
            if(listUsers is null || !listUsers.Any())
            {
                return 1;
            }
            return (int)Math.Ceiling((double)listUsers.Count / pageSize);
        }
    }

    [Parameter]
    public string? FilteredUsersData { set; get; }

    private List<User>? listUsers = new List<User>();

    private bool isFirstRender = true;

    private string? statusUserListView = "Data Is Loading...";


    private Dictionary<string, int> sortStates = new()
    {
        { "Store",     0 },
        { "Firstname", 0 },
        { "Username",  0 },
        { "Group",     0 },
        { "Status",    0 },
        { "Role",      0 }
    };

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagedUsers();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagedUsers();
        }
    }

    private void UpdatePagedUsers()
    {
        if (listUsers is not null || listUsers.Any())
        {
            pagedUsers = listUsers
                        .Skip((currentPage - 1) * pageSize)
                        .Take(pageSize)
                        .ToList();
        }

    }

    private void ToggleSort(string column)
    {
        if (listUsers is null || !listUsers.Any())
            return;

        // reset other columns
        foreach (var key in sortStates.Keys.ToList())
        {
            if (key != column)
            {
                sortStates[key] = 0;
            }
        }

        // advance state
        sortStates[column]++;

        if (sortStates[column] > 2)
        {
            sortStates[column] = 0;
        }

        switch (column)
        {
            case "Firstname":
                ApplyLogicSort(u => u.FirstName, column);
                break;

            case "Store":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Username":
                ApplyLogicSort(u => u.Username, column);
                break;

            case "Group":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Role":
                ApplyLogicSort(u => u.UserGroups.Count, column);
                break;

            case "Status":
                ApplyLogicSort(u => u.IsActive, column);
                break;
        }

        StateHasChanged();
    }


    private RenderFragment GetSortIcon(string column) => builder =>
    {
        string icon = sortStates[column] switch
        {
            1 => "▲", // ascending
            2 => "▼", // descending
            _ => ""
        };
        builder.AddContent(0, icon);
    };


    private void ApplyLogicSort<TKey>(Func<User,TKey> selector, string column)
    {
        switch (this.sortStates[column])
        {
            case 0:
                listUsers = UsersService.GetUsersService();
                UpdatePagedUsers();
                break;

            case 1:
                if(listUsers != null)
                {
                    listUsers = listUsers.OrderBy(selector).ToList();
                    UpdatePagedUsers();
                }
                break;

            case 2:
                if(listUsers != null)
                {
                    listUsers = listUsers.OrderByDescending(selector).ToList();
                    UpdatePagedUsers();
                }
                break;
        }
    }

    protected override void OnParametersSet()
    {
        if (isFirstRender == false)
        {
            if (string.IsNullOrWhiteSpace(this.FilteredUsersData))
            {
                listUsers = UsersService.GetUsersService();
            }
            else
            {
                listUsers = UsersService.SearchUserService(FilteredUsersData);
                if (listUsers is null || listUsers.Count == 0)
                {
                    statusUserListView = "No User Found";
                }

            }
            UpdatePagedUsers();
            StateHasChanged();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isFirstRender = false;
            if (string.IsNullOrWhiteSpace(this.FilteredUsersData))
            {
                listUsers = UsersService.GetUsersService();
            }
            else
            {
                listUsers = UsersService.SearchUserService(FilteredUsersData);
                if (listUsers is null || listUsers.Count ==0)
                {
                    statusUserListView = "No User Found";
                }

            }
            UpdatePagedUsers();
            StateHasChanged();
        }
    }

    
    private void SetUserStatus(int userId, bool status)
    {
        var userToUpdate = UsersService.GetUserByIdService(userId);
        if (userToUpdate is not null && userToUpdate.IsActive != status)
        {
            userToUpdate.IsActive = status;
            UsersService.UpdateUserService(userId, userToUpdate);
            listUsers = UsersService.GetUsersService();
            StateHasChanged();
        }
        else
        {
            return;
        }
    }
}
