@inject NavigationManager NavigationManager 
@inject ICustomersService CustomersService
@inject ContainerStorage ContainerStorage

@inject ICustomersService CustomersService
@attribute [StreamRendering]


<table class="table table-striped table-hover">


    <thead>
        <tr>
            <th>
                <button class="btn border-0 btn-sm"> Index </button>
            </th>
            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Customer Name </button>
            </th>

            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Phone No</button>
            </th>

            <th> 
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Email </button>
            </th>

            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Birthday </button>
            </th>

            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Points</button>
            </th>

            <th>
                <button type="button" class="btn border-0 btn-sm text-nowrap px-3" >Last Visit </button>
            </th>

            <th></th>
            <th></th>
        </tr>

    </thead>
    <tbody>
        @if (listCustomers != null && listCustomers.Any() && pagedListCustomers != null )
        {

            @foreach (var customer in pagedListCustomers)
            {
                <tr class="align-middle">
                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @(listCustomers.FindIndex(c => c.CustomerId == customer.CustomerId) + 1)
                    </td>
                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.Name
                    </td>

                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.PhoneNo
                    </td>
                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.Email
                    </td>

                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.Birthday?.ToString("dd/MM/yyyy")  
                    </td>

                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.Points
                    </td>
                    <td style="cursor:pointer" @onclick="@(e => ShowCustomerDetails(customer))">
                        @customer.LastVisitDatetime?.ToString("dd/MM/yyyy") 
                    </td>
                    <td>
                            <a class="btn btn-outline-primary btn-sm px-2 py-0 text-nowrap"> Edit </a>
                    </td>
                    <td>
                            <a class="btn btn-outline-primary btn-sm px-2 py-0 text-nowrap"> Edit Group </a>
                    </td>
                </tr>
            }

        }


        else
        {
            <tr>
                <td class="text-center text-black-50" colspan="9">
                    @statusCustomerListView
                </td>
            </tr>
        }

    </tbody>


</table>


@code {
 
    [Parameter]
    public int PageSize { get; set; }

    [Parameter]
    public int CurrentPage { get; set; }

    [Parameter]
    public EventCallback<int> TotalPagesCallBack { get; set; }

    [Parameter]
    public string? FilteredCustomersData { get; set; }

    private int previousTotalPage = -1;

    private bool isFirstRender = true;  

    private string statusCustomerListView = "Customer data is loading";

    private List<Customer>? listCustomers = new List<Customer>();

    private List<Customer>? pagedListCustomers = new List<Customer>();

    private Dictionary<string, int> sortStates = new()
    {
        { "Store",     0 },
        { "Firstname", 0 },
        { "Username",  0 },
        { "Group",     0 },
        { "Status",    0 },
        { "Role",      0 }
    };


    private void UpdatePagedCustomers()
    {
        if (listCustomers is not null && listCustomers.Any())
        {
            pagedListCustomers = listCustomers.Skip((CurrentPage - 1) * PageSize)
                                   .Take(PageSize)
                                    .ToList();

            int _totalPage = (int)Math.Ceiling((double)listCustomers.Count / PageSize);

            if (previousTotalPage != _totalPage)
            {
                previousTotalPage = _totalPage;
                TotalPagesCallBack.InvokeAsync(_totalPage);
                ContainerStorage.setTotalPages(_totalPage);
            }
            else
            {
                ContainerStorage.setTotalPages(_totalPage);

            }

        }

    }

    protected override void OnParametersSet()
    {
        if (isFirstRender == false)
        {

            if (listCustomers is null || listCustomers.Count == 0)
            {
                listCustomers = CustomersService.GetCustomersService();
                statusCustomerListView = "Data Is Loading...";
            }

            else if (string.IsNullOrWhiteSpace(this.FilteredCustomersData))
            {

                if (IsSorrting())
                {

                    statusCustomerListView = "Data Is Loading...";
                }
                else
                {
                    listCustomers = CustomersService.GetCustomersService();
                    statusCustomerListView = "Data Is Loading...";
                }

            }

            else if (!string.IsNullOrWhiteSpace(this.FilteredCustomersData))
            {
                if (IsSorrting())
                {
                    statusCustomerListView = "Data Is Loading...";
                }
                else
                {
                    listCustomers = CustomersService.SearchCustomerService(FilteredCustomersData);

                    statusCustomerListView = "Data Is Loading...";

                    if (listCustomers is null || listCustomers.Count == 0)
                    {
                        statusCustomerListView = "No User Found";
                    }
                }
            }

            this.PageSize = ContainerStorage.getLastPageSize();
            this.CurrentPage = ContainerStorage.getLastCurrentPage();

            UpdatePagedCustomers();
            StateHasChanged();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {

            isFirstRender = false;
            string currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri).Split('?', '#')[0];
            ContainerStorage.resetPaginationData(currentPath);

            if (string.IsNullOrWhiteSpace(this.FilteredCustomersData))
            {
                listCustomers = CustomersService.GetCustomersService();
            }
            else
            {
                listCustomers = CustomersService.SearchCustomerService(FilteredCustomersData);
                if (listCustomers is null || listCustomers.Count == 0)
                {
                    statusCustomerListView = "No User Found";
                }

            }

            this.CurrentPage = ContainerStorage.getLastCurrentPage();
            this.PageSize = ContainerStorage.getLastPageSize();
            UpdatePagedCustomers();
            StateHasChanged();
        }
    }


    private bool IsSorrting()
    {
        // Implement sorting logic here if needed
        return false;
    }   

    private void ShowCustomerDetails(Customer customer)
    {
        
    }



    
}
